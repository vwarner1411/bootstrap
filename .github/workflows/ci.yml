name: CI

'on':
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  linux-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck python3-pip python3-venv
          python3 -m pip install --upgrade pip
          python3 -m pip install ansible-core ansible-lint

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r requirements.yml --force

      - name: Run smoke tests
        run: |
          ./tests/smoke.sh

  macos-smoke:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          if [ -x /opt/homebrew/bin/brew ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          elif [ -x /usr/local/bin/brew ]; then
            eval "$(/usr/local/bin/brew shellenv)"
          fi
          brew update
          brew install shellcheck python
          python3 -m venv .venv-ci
          . .venv-ci/bin/activate
          python -m pip install --upgrade pip
          pip install ansible-core ansible-lint
          echo "$PWD/.venv-ci/bin" >> "$GITHUB_PATH"

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r requirements.yml --force

      - name: Run smoke tests
        run: |
          ./tests/smoke.sh

  macos-e2e:
    runs-on: macos-latest
    needs:
      - macos-smoke
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run bootstrap script on macOS with fixture dotfiles
        run: |
          if [ -x /opt/homebrew/bin/brew ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          elif [ -x /usr/local/bin/brew ]; then
            eval "$(/usr/local/bin/brew shellenv)"
          fi
          export REPO_URL="file://$PWD"
          export REPO_BRANCH="${GITHUB_REF_NAME:-main}"
          export CHEZMOI_REPO="$PWD/tests/fixtures/chezmoi"
          export WORKDIR="$RUNNER_TEMP/bootstrap-e2e"
          export PROFILE="server"
          export ANSIBLE_EXTRA_VARS='{"common_core_brew_packages":[],"macos_cli_brew_packages":["git","curl","python","ansible","ripgrep","gnupg"],"macos_cli_cask_packages":[]}'
          ./scripts/bootstrap.sh
          export PATH="$HOME/.local/bin:$PATH"
          rg --version
          gpg --version
          ansible-playbook --version
          test -d "$HOME/.oh-my-zsh"

  bootstrap-e2e:
    runs-on: ubuntu-latest
    needs:
      - linux-smoke
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run bootstrap script inside container (desktop)
        run: |
          docker run --rm \
            -v "$PWD":/workspace \
            -e REPO_URL="file:///workspace" \
            -e CHEZMOI_REPO="/workspace/tests/fixtures/chezmoi" \
            -e WORKDIR="/root/.local/share/zshell" \
            -e PROFILE="desktop" \
            ubuntu:24.04 \
            bash -lc '
              set -euo pipefail
              export DEBIAN_FRONTEND=noninteractive
              apt-get update
              apt-get install -y sudo curl git python3 python3-pip python3-venv ca-certificates
              mkdir -p /root
              export HOME=/root
              cd /workspace
              ./scripts/bootstrap.sh
              export PATH="/root/.local/bin:$PATH"
              starship --version
              yazi --version
              rg --version
              gpg --version
              ansible-playbook --version
            '

      - name: Run bootstrap script inside container (server)
        run: |
          docker run --rm \
            -v "$PWD":/workspace \
            -e REPO_URL="file:///workspace" \
            -e CHEZMOI_REPO="/workspace/tests/fixtures/chezmoi" \
            -e WORKDIR="/root/.local/share/zshell" \
            -e PROFILE="server" \
            ubuntu:24.04 \
            bash -lc '
              set -euo pipefail
              export DEBIAN_FRONTEND=noninteractive
              apt-get update
              apt-get install -y sudo curl git python3 python3-pip python3-venv ca-certificates
              mkdir -p /root
              export HOME=/root
              cd /workspace
              ./scripts/bootstrap.sh
              export PATH="/root/.local/bin:$PATH"
              ls -1 /usr/local/bin
              rg --version
              gpg --version
            '
