name: CI

'on':
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck python3-pip python3-venv
          python3 -m pip install --upgrade pip
          python3 -m pip install ansible==9.3.0 ansible-lint==24.6.0

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r requirements.yml --force

      - name: Run smoke tests
        run: |
          ./tests/smoke.sh

  macos-smoke:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          if [ -x /opt/homebrew/bin/brew ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          elif [ -x /usr/local/bin/brew ]; then
            eval "$(/usr/local/bin/brew shellenv)"
          fi
          brew update
          brew install shellcheck python ansible ansible-lint

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r requirements.yml --force

      - name: Run smoke tests
        run: |
          ./tests/smoke.sh

  bootstrap-e2e:
    runs-on: ubuntu-latest
    needs:
      - tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run bootstrap script inside container (desktop)
        run: |
          docker run --rm \
            -v "$PWD":/workspace \
            -e REPO_URL="file:///workspace" \
            -e CHEZMOI_REPO="/workspace/tests/fixtures/chezmoi" \
            -e WORKDIR="/root/.local/share/zshell" \
            -e PROFILE="desktop" \
            ubuntu:24.04 \
            bash -lc '
              set -euo pipefail
              export DEBIAN_FRONTEND=noninteractive
              apt-get update
              apt-get install -y sudo curl git python3 python3-pip python3-venv ca-certificates
              mkdir -p /root
              export HOME=/root
              cd /workspace
              ./scripts/bootstrap.sh
              export PATH="/root/.local/bin:$PATH"
              starship --version
              yazi --version
              rg --version
              gpg --version
              ansible-playbook --version
            '

      - name: Run bootstrap script inside container (server)
        run: |
          docker run --rm \
            -v "$PWD":/workspace \
            -e REPO_URL="file:///workspace" \
            -e CHEZMOI_REPO="/workspace/tests/fixtures/chezmoi" \
            -e WORKDIR="/root/.local/share/zshell" \
            -e PROFILE="server" \
            ubuntu:24.04 \
            bash -lc '
              set -euo pipefail
              export DEBIAN_FRONTEND=noninteractive
              apt-get update
              apt-get install -y sudo curl git python3 python3-pip python3-venv ca-certificates
              mkdir -p /root
              export HOME=/root
              cd /workspace
              ./scripts/bootstrap.sh
              export PATH="/root/.local/bin:$PATH"
              ls -1 /usr/local/bin
              rg --version
              gpg --version
            '
