- name: Ensure Homebrew bundle for CLI tools is installed
  community.general.homebrew:
    name: "{{ macos_cli_brew_packages }}"
    state: latest
    update_homebrew: true
  become: "{{ (ansible_facts['user_id'] | default('')) == 'root' }}"
  become_user: "{{ shell_user | default((ansible_facts['env'] | default({})).get('SUDO_USER', (ansible_facts['env'] | default({})).get('USER', ansible_facts['user_id'] | default('root')))) }}"
  environment:
    HOME: "{{ shell_home | default((ansible_facts['env'] | default({})).get('HOME', '/var/root')) }}"
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ (ansible_facts['env'] | default({})).get('PATH', '/usr/bin:/bin') }}"

- name: Install Homebrew casks for desktop tools
  community.general.homebrew_cask:
    name: "{{ macos_cli_cask_packages }}"
    state: latest
  become: "{{ (ansible_facts['user_id'] | default('')) == 'root' }}"
  become_user: "{{ shell_user | default((ansible_facts['env'] | default({})).get('SUDO_USER', (ansible_facts['env'] | default({})).get('USER', ansible_facts['user_id'] | default('root')))) }}"
  environment:
    HOME: "{{ shell_home | default((ansible_facts['env'] | default({})).get('HOME', '/var/root')) }}"
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ (ansible_facts['env'] | default({})).get('PATH', '/usr/bin:/bin') }}"
  when: macos_cli_cask_packages | length > 0
