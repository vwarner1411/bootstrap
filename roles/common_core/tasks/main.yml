- name: Include OS-specific variable defaults
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_facts.os_family | lower }}.yml"
        - default.yml
      paths:
        - "{{ role_path }}/vars"

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when: ansible_facts.os_family == "Debian"

- name: Upgrade installed packages (Debian)
  ansible.builtin.apt:
    upgrade: dist
  when: ansible_facts.os_family == "Debian"

- name: Install core packages on Debian-based systems
  ansible.builtin.apt:
    name: "{{ common_core_debian_packages }}"
    state: present
  when: ansible_facts.os_family == "Debian"

- name: Install open-vm-tools on server profile
  ansible.builtin.apt:
    name: open-vm-tools
    state: present
  when:
    - ansible_facts.os_family == "Debian"
    - profile | lower == "server"

- name: Ensure prerequisite directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /usr/local/bin
    - /usr/local/lib
  when: ansible_facts.os_family == "Debian"

- name: Check for batcat binary on Debian
  ansible.builtin.stat:
    path: /usr/bin/batcat
  register: common_core_batcat_binary
  when: ansible_facts.os_family == "Debian"

- name: Ensure bat symlink exists on Debian
  ansible.builtin.file:
    src: /usr/bin/batcat
    dest: /usr/local/bin/bat
    state: link
    force: true
  when:
    - ansible_facts.os_family == "Debian"
    - common_core_batcat_binary.stat.exists

- name: Check for fdfind binary on Debian
  ansible.builtin.stat:
    path: /usr/bin/fdfind
  register: common_core_fdfind_binary
  when: ansible_facts.os_family == "Debian"

- name: Ensure fd symlink exists on Debian
  ansible.builtin.file:
    src: /usr/bin/fdfind
    dest: /usr/local/bin/fd
    state: link
    force: true
  when:
    - ansible_facts.os_family == "Debian"
    - common_core_fdfind_binary.stat.exists

- name: Resolve Homebrew execution context (macOS)
  ansible.builtin.set_fact:
    common_core_macos_brew_target_user: >-
      {{
        shell_user
        | default(
            (ansible_facts['env'] | default({})).get(
              'SUDO_USER',
              (ansible_facts['env'] | default({})).get(
                'USER',
                ansible_facts['user_id'] | default('root')
              )
            )
          )
      }}
    common_core_macos_brew_target_home: >-
      {{
        shell_home
        | default(
            (ansible_facts['env'] | default({})).get('HOME', '/var/root')
          )
      }}
    common_core_macos_brew_target_path: >-
      /opt/homebrew/bin:/usr/local/bin:{{ (ansible_facts['env'] | default({})).get('PATH', '/usr/bin:/bin') }}
  when: ansible_facts.system == "Darwin"

- name: Ensure Homebrew is installed (macOS)
  community.general.homebrew:
    name: []
    update_homebrew: false
    state: present
  become: "{{ (ansible_facts['user_id'] | default('')) == 'root' }}"
  become_user: "{{ common_core_macos_brew_target_user }}"
  environment:
    HOME: "{{ common_core_macos_brew_target_home }}"
    PATH: "{{ common_core_macos_brew_target_path }}"
  when: ansible_facts.system == "Darwin"

- name: Install core packages with Homebrew (macOS)
  community.general.homebrew:
    name: "{{ common_core_brew_packages }}"
    state: latest
    update_homebrew: true
  become: "{{ (ansible_facts['user_id'] | default('')) == 'root' }}"
  become_user: "{{ common_core_macos_brew_target_user }}"
  environment:
    HOME: "{{ common_core_macos_brew_target_home }}"
    PATH: "{{ common_core_macos_brew_target_path }}"
  when: ansible_facts.system == "Darwin"
