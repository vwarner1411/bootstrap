# Everything in this file only applies on Debian-family hosts

- name: Update apt cache and install base packages
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
    name:
      - ncurses-term
      - xz-utils
      - bzip2
      - tar
      - curl
      - ca-certificates
      - build-essential
      - python3-venv
      - pipx
      - unzip
    state: present
  when: ansible_facts.os_family == "Debian"

- name: Install build dependencies for mosh
  ansible.builtin.apt:
    name:
      - protobuf-compiler
      - libprotobuf-dev
      - pkg-config
      - libutempter-dev
      - libncurses-dev
      - zlib1g-dev
      - autoconf
      - automake
      - libtool
      - libssl-dev
    state: present
  when: ansible_facts.os_family == "Debian"

- name: Define GitHub download staging directory
  ansible.builtin.set_fact:
    linux_cli_download_dir: /tmp/zshell-github-downloads
  when: ansible_facts.os_family == "Debian"

- name: Ensure GitHub download staging directory exists
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}"
    state: directory
    mode: "0755"
  when: ansible_facts.os_family == "Debian"

- name: Normalize architecture strings for GitHub assets
  ansible.builtin.set_fact:
    arch_cpu: >-
      {{ 'x86_64' if ansible_facts.architecture in ['x86_64', 'amd64']
         else 'aarch64' if ansible_facts.architecture in ['aarch64', 'arm64']
         else ansible_facts.architecture }}
    arch_go: >-
      {{ 'amd64' if ansible_facts.architecture in ['x86_64', 'amd64']
         else 'arm64' if ansible_facts.architecture in ['aarch64', 'arm64']
         else ansible_facts.architecture }}
  when: ansible_facts.os_family == "Debian"

# PowerShell ###################################################################
- name: Check current PowerShell version
  ansible.builtin.command: pwsh --version
  register: powershell_version_check
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute existing PowerShell version string
  ansible.builtin.set_fact:
    powershell_version_pretty: >-
      {{ (powershell_version_check.rc == 0) | ternary((powershell_version_check.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report existing PowerShell version
  ansible.builtin.debug:
    msg: "PowerShell version (pre-install): {{ powershell_version_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Fetch latest PowerShell release metadata
  ansible.builtin.uri:
    url: https://api.github.com/repos/PowerShell/PowerShell/releases/latest
    return_content: true
  register: powershell_release
  when: ansible_facts.os_family == "Debian"

- name: Set PowerShell release facts
  ansible.builtin.set_fact:
    powershell_target_version: "{{ powershell_release.json.tag_name }}"
    powershell_asset: >-
      {{
        (
          powershell_release.json.assets
          | selectattr('name', 'search', 'linux-x64\.tar\.gz$')
          | map(attribute='browser_download_url')
          | list
          | first
        )
        | default('', true)
      }}
  when: ansible_facts.os_family == "Debian"

- name: Debug PowerShell asset selection
  ansible.builtin.debug:
    msg:
      asset_names: "{{ powershell_release.json.assets | default([]) | map(attribute='name') | list }}"
      asset_url: "{{ powershell_asset }}"
  when: ansible_facts.os_family == "Debian"

- name: Download PowerShell release
  ansible.builtin.get_url:
    url: "{{ powershell_asset }}"
    dest: /tmp/powershell.tar.gz
    mode: "0644"
  when:
    - ansible_facts.os_family == "Debian"
    - powershell_asset | length > 0
    - powershell_version_check.stdout is not defined or powershell_target_version not in powershell_version_check.stdout

- name: Create PowerShell installation directory
  ansible.builtin.file:
    path: /opt/microsoft/powershell
    state: directory
    mode: "0755"
  when: ansible_facts.os_family == "Debian"

- name: Extract PowerShell archive
  ansible.builtin.unarchive:
    src: /tmp/powershell.tar.gz
    dest: /opt/microsoft/powershell
    remote_src: true
  when:
    - ansible_facts.os_family == "Debian"
    - powershell_asset | length > 0
    - powershell_version_check.stdout is not defined or powershell_target_version not in powershell_version_check.stdout

- name: Ensure PowerShell binary is executable
  ansible.builtin.file:
    path: /opt/microsoft/powershell/pwsh
    mode: "0755"
    state: file
  when: ansible_facts.os_family == "Debian"

- name: Ensure PowerShell symlink exists
  ansible.builtin.file:
    src: /opt/microsoft/powershell/pwsh
    dest: /usr/local/bin/pwsh
    state: link
    force: true
  when: ansible_facts.os_family == "Debian"

- name: Capture PowerShell version after install
  ansible.builtin.command: pwsh --version
  register: powershell_version_post
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute installed PowerShell version string
  ansible.builtin.set_fact:
    powershell_version_post_pretty: >-
      {{ (powershell_version_post.rc == 0) | ternary((powershell_version_post.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report installed PowerShell version
  ansible.builtin.debug:
    msg: "PowerShell version after install: {{ powershell_version_post_pretty }}"
  when: ansible_facts.os_family == "Debian"

# kitty ########################################################################
- name: Check current kitty version
  ansible.builtin.command: kitty --version
  register: kitty_version_check
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute existing kitty version string
  ansible.builtin.set_fact:
    kitty_version_pretty: >-
      {{ (kitty_version_check.rc == 0) | ternary((kitty_version_check.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report existing kitty version
  ansible.builtin.debug:
    msg: "Kitty version (pre-install): {{ kitty_version_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Fetch latest kitty release metadata
  ansible.builtin.uri:
    url: https://api.github.com/repos/kovidgoyal/kitty/releases/latest
    return_content: true
    headers:
      Accept: application/vnd.github+json
      User-Agent: zshell-ansible
  register: kitty_release
  retries: 3
  delay: 2
  until: kitty_release.status == 200
  when: ansible_facts.os_family == "Debian"

- name: Set kitty release facts
  ansible.builtin.set_fact:
    kitty_target_version: "{{ (kitty_release.json.tag_name | default('')) | regex_replace('^v', '') }}"
  when: ansible_facts.os_family == "Debian"

- name: Set kitty asset URL
  ansible.builtin.set_fact:
    kitty_asset: >-
      {{
        (kitty_release.json.assets | default([]))
        | selectattr('name', 'equalto', 'kitty-' ~ kitty_target_version ~ '-' ~ arch_cpu ~ '.txz')
        | map(attribute='browser_download_url')
        | list
        | first
        | default('', true)
      }}
  when: ansible_facts.os_family == "Debian"
- name: Debug kitty asset selection
  ansible.builtin.debug:
    msg:
      asset_names: "{{ kitty_release.json.assets | default([]) | map(attribute='name') | list }}"
      asset_url: "{{ kitty_asset }}"
  when: ansible_facts.os_family == "Debian"

- name: Determine if kitty install is required
  ansible.builtin.set_fact:
    kitty_install_required: >-
      {{
        (kitty_asset | length > 0) and
        (
          (kitty_version_check.rc | default(1)) != 0 or
          (kitty_version_check.stdout is defined and kitty_target_version not in kitty_version_check.stdout)
        )
      }}
  when: ansible_facts.os_family == "Debian"

- name: Download kitty release
  ansible.builtin.get_url:
    url: "{{ kitty_asset }}"
    dest: "{{ linux_cli_download_dir }}/kitty.txz"
    mode: "0644"
  when:
    - ansible_facts.os_family == "Debian"
    - kitty_install_required

- name: Remove existing kitty version directory
  ansible.builtin.file:
    path: "/opt/kitty-{{ kitty_target_version }}"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - kitty_install_required

- name: Create kitty installation directory
  ansible.builtin.file:
    path: "/opt/kitty-{{ kitty_target_version }}"
    state: directory
    mode: "0755"
  when: ansible_facts.os_family == "Debian"

- name: Extract kitty release
  ansible.builtin.unarchive:
    src: "{{ linux_cli_download_dir }}/kitty.txz"
    dest: "/opt/kitty-{{ kitty_target_version }}"
    remote_src: true
  when:
    - ansible_facts.os_family == "Debian"
    - kitty_install_required

- name: Ensure kitty binary permissions
  ansible.builtin.file:
    path: "/opt/kitty-{{ kitty_target_version }}/bin/kitty"
    state: file
    mode: "0755"
  when:
    - ansible_facts.os_family == "Debian"
    - kitty_install_required

- name: Update kitty current symlink
  ansible.builtin.file:
    src: "/opt/kitty-{{ kitty_target_version }}"
    dest: /opt/kitty
    state: link
    force: true
  when:
    - ansible_facts.os_family == "Debian"
    - kitty_install_required

- name: Ensure kitty symlink exists
  ansible.builtin.file:
    src: /opt/kitty/bin/kitty
    dest: /usr/local/bin/kitty
    state: link
    force: true
  when:
    - ansible_facts.os_family == "Debian"
    - (kitty_version_check.rc | default(1)) == 0 or kitty_install_required

- name: Clean kitty archive
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/kitty.txz"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - kitty_install_required

- name: Capture kitty version after install
  ansible.builtin.command: kitty --version
  register: kitty_version_post
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute installed kitty version string
  ansible.builtin.set_fact:
    kitty_version_post_pretty: >-
      {{ (kitty_version_post.rc == 0) | ternary((kitty_version_post.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report installed kitty version
  ansible.builtin.debug:
    msg: "Kitty version after install: {{ kitty_version_post_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Debug kitty version command result
  ansible.builtin.debug:
    var: kitty_version_post
  when: ansible_facts.os_family == "Debian"

# btop #########################################################################
- name: Check current btop version
  ansible.builtin.command: btop --version
  register: btop_version_check
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute existing btop version string
  ansible.builtin.set_fact:
    btop_version_pretty: >-
      {{ (btop_version_check.rc == 0) | ternary((btop_version_check.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report existing btop version
  ansible.builtin.debug:
    msg: "Btop version (pre-install): {{ btop_version_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Fetch latest btop release metadata
  ansible.builtin.uri:
    url: https://api.github.com/repos/aristocratos/btop/releases/latest
    return_content: true
    headers:
      Accept: application/vnd.github+json
      User-Agent: zshell-ansible
  register: btop_release
  retries: 3
  delay: 2
  until: btop_release.status == 200
  when: ansible_facts.os_family == "Debian"

- name: Set btop release facts
  ansible.builtin.set_fact:
    btop_target_version: "{{ (btop_release.json.tag_name | default('')) | regex_replace('^v', '') }}"
  when: ansible_facts.os_family == "Debian"

- name: Set btop asset URL
  ansible.builtin.set_fact:
    btop_asset: >-
      {{
        (btop_release.json.assets | default([]))
        | selectattr('name', 'match', '^btop-' ~ arch_cpu ~ '-linux-musl\\.tbz$')
        | map(attribute='browser_download_url')
        | list
        | first
        | default('', true)
      }}
  when: ansible_facts.os_family == "Debian"
- name: Debug btop asset selection
  ansible.builtin.debug:
    msg:
      asset_names: "{{ btop_release.json.assets | default([]) | map(attribute='name') | list }}"
      asset_url: "{{ btop_asset }}"
  when: ansible_facts.os_family == "Debian"

- name: Determine if btop install is required
  ansible.builtin.set_fact:
    btop_install_required: >-
      {{
        (btop_asset | length > 0) and
        (
          (btop_version_check.rc | default(1)) != 0 or
          (btop_version_check.stdout is defined and btop_target_version not in btop_version_check.stdout)
        )
      }}
  when: ansible_facts.os_family == "Debian"

- name: Download btop release
  ansible.builtin.get_url:
    url: "{{ btop_asset }}"
    dest: "{{ linux_cli_download_dir }}/btop.tbz"
    mode: "0644"
  when:
    - ansible_facts.os_family == "Debian"
    - btop_install_required

- name: Unpack btop release
  ansible.builtin.unarchive:
    src: "{{ linux_cli_download_dir }}/btop.tbz"
    dest: "{{ linux_cli_download_dir }}"
    remote_src: true
  when:
    - ansible_facts.os_family == "Debian"
    - btop_install_required

- name: Install btop
  ansible.builtin.command:
    cmd: ./install.sh --prefix /usr/local --silent
    chdir: "{{ linux_cli_download_dir }}/btop"
  changed_when: true
  when:
    - ansible_facts.os_family == "Debian"
    - btop_install_required

- name: Remove btop build directory
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/btop"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - btop_install_required

- name: Clean btop archive
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/btop.tbz"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - btop_install_required

- name: Capture btop version after install
  ansible.builtin.command: btop --version
  register: btop_version_post
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute installed btop version string
  ansible.builtin.set_fact:
    btop_version_post_pretty: >-
      {{ (btop_version_post.rc == 0) | ternary((btop_version_post.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report installed btop version
  ansible.builtin.debug:
    msg: "Btop version after install: {{ btop_version_post_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Debug btop version command result
  ansible.builtin.debug:
    var: btop_version_post
  when: ansible_facts.os_family == "Debian"

# lsd ##########################################################################
- name: Check current lsd version
  ansible.builtin.command: lsd --version
  register: lsd_version_check
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute existing lsd version string
  ansible.builtin.set_fact:
    lsd_version_pretty: >-
      {{ (lsd_version_check.rc == 0) | ternary((lsd_version_check.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report existing lsd version
  ansible.builtin.debug:
    msg: "Lsd version (pre-install): {{ lsd_version_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Fetch latest lsd release metadata
  ansible.builtin.uri:
    url: https://api.github.com/repos/lsd-rs/lsd/releases/latest
    return_content: true
    headers:
      Accept: application/vnd.github+json
      User-Agent: zshell-ansible
  register: lsd_release
  retries: 3
  delay: 2
  until: lsd_release.status == 200
  when: ansible_facts.os_family == "Debian"

- name: Set lsd release facts
  ansible.builtin.set_fact:
    lsd_target_version: "{{ (lsd_release.json.tag_name | default('')) | regex_replace('^v', '') }}"
    lsd_triple: "{{ arch_cpu ~ '-unknown-linux-gnu' }}"
  when: ansible_facts.os_family == "Debian"

- name: Set lsd asset URL
  ansible.builtin.set_fact:
    lsd_triple: "{{ arch_cpu ~ '-unknown-linux-gnu' }}"
    lsd_asset: >-
      {{
        (lsd_release.json.assets | default([]))
        | selectattr('name', 'match', '^lsd-' ~ lsd_target_version ~ '-' ~ lsd_triple ~ '\\.tar\\.gz$')
        | map(attribute='browser_download_url')
        | list
        | first
        | default('', true)
      }}
  when: ansible_facts.os_family == "Debian"
- name: Debug lsd asset selection
  ansible.builtin.debug:
    msg:
      asset_names: "{{ lsd_release.json.assets | default([]) | map(attribute='name') | list }}"
      asset_url: "{{ lsd_asset }}"
  when: ansible_facts.os_family == "Debian"

- name: Determine if lsd install is required
  ansible.builtin.set_fact:
    lsd_install_required: >-
      {{
        (lsd_asset | length > 0) and
        (
          (lsd_version_check.rc | default(1)) != 0 or
          (lsd_version_check.stdout is defined and lsd_target_version not in lsd_version_check.stdout)
        )
      }}
  when: ansible_facts.os_family == "Debian"

- name: Download lsd release
  ansible.builtin.get_url:
    url: "{{ lsd_asset }}"
    dest: "{{ linux_cli_download_dir }}/lsd.tar.gz"
    mode: "0644"
  when:
    - ansible_facts.os_family == "Debian"
    - lsd_install_required

- name: Unpack lsd release
  ansible.builtin.unarchive:
    src: "{{ linux_cli_download_dir }}/lsd.tar.gz"
    dest: "{{ linux_cli_download_dir }}"
    remote_src: true
  when:
    - ansible_facts.os_family == "Debian"
    - lsd_install_required

- name: Install lsd binary
  ansible.builtin.copy:
    src: "{{ linux_cli_download_dir }}/lsd-{{ lsd_target_version }}-{{ lsd_triple }}/lsd"
    dest: /usr/local/bin/lsd
    mode: "0755"
    remote_src: true
  when:
    - ansible_facts.os_family == "Debian"
    - lsd_install_required

- name: Remove lsd build directory
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/lsd-{{ lsd_target_version }}-{{ lsd_triple }}"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - lsd_install_required

- name: Clean lsd archive
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/lsd.tar.gz"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - lsd_install_required

- name: Capture lsd version after install
  ansible.builtin.command: lsd --version
  register: lsd_version_post
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute installed lsd version string
  ansible.builtin.set_fact:
    lsd_version_post_pretty: >-
      {{ (lsd_version_post.rc == 0) | ternary((lsd_version_post.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report installed lsd version
  ansible.builtin.debug:
    msg: "Lsd version after install: {{ lsd_version_post_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Debug lsd version command result
  ansible.builtin.debug:
    var: lsd_version_post
  when: ansible_facts.os_family == "Debian"

# fzf ##########################################################################
- name: Check current fzf version
  ansible.builtin.command: fzf --version
  register: fzf_version_check
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute existing fzf version string
  ansible.builtin.set_fact:
    fzf_version_pretty: >-
      {{ (fzf_version_check.rc == 0) | ternary((fzf_version_check.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report existing fzf version
  ansible.builtin.debug:
    msg: "Fzf version (pre-install): {{ fzf_version_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Fetch latest fzf release metadata
  ansible.builtin.uri:
    url: https://api.github.com/repos/junegunn/fzf/releases/latest
    return_content: true
    headers:
      Accept: application/vnd.github+json
      User-Agent: zshell-ansible
  register: fzf_release
  retries: 3
  delay: 2
  until: fzf_release.status == 200
  when: ansible_facts.os_family == "Debian"

- name: Set fzf release facts
  ansible.builtin.set_fact:
    fzf_target_version: "{{ (fzf_release.json.tag_name | default('')) | regex_replace('^v', '') }}"
  when: ansible_facts.os_family == "Debian"

- name: Set fzf asset URL
  ansible.builtin.set_fact:
    fzf_asset: >-
      {{
        (fzf_release.json.assets | default([]))
        | selectattr('name', 'match', '^fzf-' ~ fzf_target_version ~ '-linux_' ~ arch_go ~ '\\.tar\\.gz$')
        | map(attribute='browser_download_url')
        | list
        | first
        | default('', true)
      }}
  when: ansible_facts.os_family == "Debian"
- name: Debug fzf asset selection
  ansible.builtin.debug:
    msg:
      asset_names: "{{ fzf_release.json.assets | default([]) | map(attribute='name') | list }}"
      asset_url: "{{ fzf_asset }}"
  when: ansible_facts.os_family == "Debian"

- name: Determine if fzf install is required
  ansible.builtin.set_fact:
    fzf_install_required: >-
      {{
        (fzf_asset | length > 0) and
        (
          (fzf_version_check.rc | default(1)) != 0 or
          (fzf_version_check.stdout is defined and fzf_target_version not in fzf_version_check.stdout)
        )
      }}
  when: ansible_facts.os_family == "Debian"

- name: Download fzf release
  ansible.builtin.get_url:
    url: "{{ fzf_asset }}"
    dest: "{{ linux_cli_download_dir }}/fzf.tar.gz"
    mode: "0644"
  when:
    - ansible_facts.os_family == "Debian"
    - fzf_install_required

- name: Unpack fzf release
  ansible.builtin.unarchive:
    src: "{{ linux_cli_download_dir }}/fzf.tar.gz"
    dest: "{{ linux_cli_download_dir }}"
    remote_src: true
  when:
    - ansible_facts.os_family == "Debian"
    - fzf_install_required

- name: Install fzf binary
  ansible.builtin.copy:
    src: "{{ linux_cli_download_dir }}/fzf"
    dest: /usr/local/bin/fzf
    mode: "0755"
    remote_src: true
  when:
    - ansible_facts.os_family == "Debian"
    - fzf_install_required

- name: Remove fzf build artifacts
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/fzf"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - fzf_install_required

- name: Clean fzf archive
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/fzf.tar.gz"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - fzf_install_required

- name: Capture fzf version after install
  ansible.builtin.command: fzf --version
  register: fzf_version_post
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute installed fzf version string
  ansible.builtin.set_fact:
    fzf_version_post_pretty: >-
      {{ (fzf_version_post.rc == 0) | ternary((fzf_version_post.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report installed fzf version
  ansible.builtin.debug:
    msg: "Fzf version after install: {{ fzf_version_post_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Debug fzf version command result
  ansible.builtin.debug:
    var: fzf_version_post
  when: ansible_facts.os_family == "Debian"

# starship #####################################################################
- name: Check current starship version
  ansible.builtin.command: starship --version
  register: starship_version_check
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute existing starship version string
  ansible.builtin.set_fact:
    starship_version_pretty: >-
      {{ (starship_version_check.rc == 0) | ternary((starship_version_check.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report existing starship version
  ansible.builtin.debug:
    msg: "Starship version (pre-install): {{ starship_version_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Fetch latest starship release metadata
  ansible.builtin.uri:
    url: https://api.github.com/repos/starship/starship/releases/latest
    return_content: true
    headers:
      Accept: application/vnd.github+json
      User-Agent: zshell-ansible
  register: starship_release
  retries: 3
  delay: 2
  until: starship_release.status == 200
  when: ansible_facts.os_family == "Debian"

- name: Set starship release facts
  ansible.builtin.set_fact:
    starship_target_version: "{{ (starship_release.json.tag_name | default('')) | regex_replace('^v', '') }}"
  when: ansible_facts.os_family == "Debian"

- name: Set starship asset URL
  ansible.builtin.set_fact:
    starship_asset: >-
      {{
        (starship_release.json.assets | default([]))
        | selectattr('name', 'match', '^starship-' ~ arch_cpu ~ '-unknown-linux-gnu\\.tar\\.gz$')
        | map(attribute='browser_download_url')
        | list
        | first
        | default('', true)
      }}
  when: ansible_facts.os_family == "Debian"
- name: Debug starship asset selection
  ansible.builtin.debug:
    msg:
      asset_names: "{{ starship_release.json.assets | default([]) | map(attribute='name') | list }}"
      asset_url: "{{ starship_asset }}"
  when: ansible_facts.os_family == "Debian"

- name: Determine if starship install is required
  ansible.builtin.set_fact:
    starship_install_required: >-
      {{
        (starship_asset | length > 0) and
        (
          (starship_version_check.rc | default(1)) != 0 or
          (starship_version_check.stdout is defined and starship_target_version not in starship_version_check.stdout)
        )
      }}
  when: ansible_facts.os_family == "Debian"

- name: Download starship release
  ansible.builtin.get_url:
    url: "{{ starship_asset }}"
    dest: "{{ linux_cli_download_dir }}/starship.tar.gz"
    mode: "0644"
  when:
    - ansible_facts.os_family == "Debian"
    - starship_install_required

- name: Unpack starship release
  ansible.builtin.unarchive:
    src: "{{ linux_cli_download_dir }}/starship.tar.gz"
    dest: "{{ linux_cli_download_dir }}"
    remote_src: true
  when:
    - ansible_facts.os_family == "Debian"
    - starship_install_required

- name: Install starship binary
  ansible.builtin.copy:
    src: "{{ linux_cli_download_dir }}/starship"
    dest: /usr/local/bin/starship
    mode: "0755"
    remote_src: true
  when:
    - ansible_facts.os_family == "Debian"
    - starship_install_required

- name: Remove starship build artifacts
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/starship"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - starship_install_required

- name: Clean starship archive
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/starship.tar.gz"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - starship_install_required

- name: Capture starship version after install
  ansible.builtin.command: starship --version
  register: starship_version_post
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute installed starship version string
  ansible.builtin.set_fact:
    starship_version_post_pretty: >-
      {{ (starship_version_post.rc == 0) | ternary((starship_version_post.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report installed starship version
  ansible.builtin.debug:
    msg: "Starship version after install: {{ starship_version_post_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Debug starship version command result
  ansible.builtin.debug:
    var: starship_version_post
  when: ansible_facts.os_family == "Debian"

# yazi #########################################################################
- name: Check current yazi version
  ansible.builtin.command: yazi --version
  register: yazi_version_check
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute existing yazi version string
  ansible.builtin.set_fact:
    yazi_version_pretty: >-
      {{ (yazi_version_check.rc == 0) | ternary((yazi_version_check.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report existing yazi version
  ansible.builtin.debug:
    msg: "Yazi version (pre-install): {{ yazi_version_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Fetch latest yazi release metadata
  ansible.builtin.uri:
    url: https://api.github.com/repos/sxyazi/yazi/releases/latest
    return_content: true
    headers:
      Accept: application/vnd.github+json
      User-Agent: zshell-ansible
  register: yazi_release
  retries: 3
  delay: 2
  until: yazi_release.status == 200
  when: ansible_facts.os_family == "Debian"

- name: Set yazi release facts
  ansible.builtin.set_fact:
    yazi_target_version: "{{ (yazi_release.json.tag_name | default('')) | regex_replace('^v', '') }}"
  when: ansible_facts.os_family == "Debian"

- name: Set yazi asset URL
  ansible.builtin.set_fact:
    yazi_asset: >-
      {{
        (yazi_release.json.assets | default([]))
        | selectattr('name', 'match', '^yazi-' ~ arch_cpu ~ '-unknown-linux-gnu\\.tar\\.xz$')
        | map(attribute='browser_download_url')
        | list
        | first
        | default('', true)
      }}
  when: ansible_facts.os_family == "Debian"
- name: Debug yazi asset selection
  ansible.builtin.debug:
    msg:
      asset_names: "{{ yazi_release.json.assets | default([]) | map(attribute='name') | list }}"
      asset_url: "{{ yazi_asset }}"
  when: ansible_facts.os_family == "Debian"

- name: Determine if yazi install is required
  ansible.builtin.set_fact:
    yazi_install_required: >-
      {{
        (yazi_asset | length > 0) and
        (
          (yazi_version_check.rc | default(1)) != 0 or
          (yazi_version_check.stdout is defined and yazi_target_version not in yazi_version_check.stdout)
        )
      }}
  when: ansible_facts.os_family == "Debian"

- name: Download yazi release
  ansible.builtin.get_url:
    url: "{{ yazi_asset }}"
    dest: "{{ linux_cli_download_dir }}/yazi.tar.xz"
    mode: "0644"
  when:
    - ansible_facts.os_family == "Debian"
    - yazi_install_required

- name: Ensure yazi version directory exists
  ansible.builtin.file:
    path: "/opt/yazi-{{ yazi_target_version }}"
    state: directory
    mode: "0755"
  when:
    - ansible_facts.os_family == "Debian"
    - yazi_install_required

- name: Extract yazi release
  ansible.builtin.unarchive:
    src: "{{ linux_cli_download_dir }}/yazi.tar.xz"
    dest: "/opt/yazi-{{ yazi_target_version }}"
    remote_src: true
    extra_opts:
      - "--strip-components=1"
  when:
    - ansible_facts.os_family == "Debian"
    - yazi_install_required

- name: Update yazi current symlink
  ansible.builtin.file:
    src: "/opt/yazi-{{ yazi_target_version }}"
    dest: /opt/yazi
    state: link
    force: true
  when:
    - ansible_facts.os_family == "Debian"
    - yazi_install_required

- name: Ensure yazi binary permissions
  ansible.builtin.file:
    path: /opt/yazi/bin/yazi
    state: file
    mode: "0755"
  when:
    - ansible_facts.os_family == "Debian"
    - yazi_install_required

- name: Ensure yazi symlink exists
  ansible.builtin.file:
    src: /opt/yazi/bin/yazi
    dest: /usr/local/bin/yazi
    state: link
    force: true
  when:
    - ansible_facts.os_family == "Debian"
    - (yazi_install_required or (yazi_version_check.rc | default(1)) == 0)

- name: Clean yazi archive
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/yazi.tar.xz"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - yazi_install_required

- name: Capture yazi version after install
  ansible.builtin.command: yazi --version
  register: yazi_version_post
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute installed yazi version string
  ansible.builtin.set_fact:
    yazi_version_post_pretty: >-
      {{ (yazi_version_post.rc == 0) | ternary((yazi_version_post.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report installed yazi version
  ansible.builtin.debug:
    msg: "Yazi version after install: {{ yazi_version_post_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Debug yazi version command result
  ansible.builtin.debug:
    var: yazi_version_post
  when: ansible_facts.os_family == "Debian"

# mosh #########################################################################
- name: Check current mosh version
  ansible.builtin.command: mosh --version
  register: mosh_version_check
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute existing mosh version string
  ansible.builtin.set_fact:
    mosh_version_pretty: >-
      {{ (mosh_version_check.rc == 0) | ternary((mosh_version_check.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report existing mosh version
  ansible.builtin.debug:
    msg: "Mosh version (pre-install): {{ mosh_version_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Fetch latest mosh release metadata
  ansible.builtin.uri:
    url: https://api.github.com/repos/mobile-shell/mosh/releases/latest
    return_content: true
    headers:
      Accept: application/vnd.github+json
      User-Agent: zshell-ansible
  register: mosh_release
  retries: 3
  delay: 2
  until: mosh_release.status == 200
  when: ansible_facts.os_family == "Debian"

- name: Set mosh release facts
  ansible.builtin.set_fact:
    mosh_target_version: "{{ (mosh_release.json.tag_name | default('')) | regex_replace('^v', '') }}"
  when: ansible_facts.os_family == "Debian"

- name: Set mosh asset URL
  ansible.builtin.set_fact:
    mosh_asset: >-
      {{
        (mosh_release.json.assets | default([]))
        | selectattr('name', 'match', '^mosh-' ~ mosh_target_version ~ '\\.tar\\.gz$')
        | map(attribute='browser_download_url')
        | list
        | first
        | default('', true)
      }}
  when: ansible_facts.os_family == "Debian"
- name: Debug mosh asset selection
  ansible.builtin.debug:
    msg:
      asset_names: "{{ mosh_release.json.assets | default([]) | map(attribute='name') | list }}"
      asset_url: "{{ mosh_asset }}"
  when: ansible_facts.os_family == "Debian"

- name: Determine if mosh install is required
  ansible.builtin.set_fact:
    mosh_install_required: >-
      {{
        (mosh_asset | length > 0) and
        (
          (mosh_version_check.rc | default(1)) != 0 or
          (mosh_version_check.stdout is defined and mosh_target_version not in mosh_version_check.stdout)
        )
      }}
  when: ansible_facts.os_family == "Debian"

- name: Download mosh release
  ansible.builtin.get_url:
    url: "{{ mosh_asset }}"
    dest: "{{ linux_cli_download_dir }}/mosh.tar.gz"
    mode: "0644"
  when:
    - ansible_facts.os_family == "Debian"
    - mosh_install_required

- name: Unpack mosh release
  ansible.builtin.unarchive:
    src: "{{ linux_cli_download_dir }}/mosh.tar.gz"
    dest: "{{ linux_cli_download_dir }}"
    remote_src: true
  when:
    - ansible_facts.os_family == "Debian"
    - mosh_install_required

- name: Configure mosh
  ansible.builtin.command:
    cmd: ./configure --prefix=/usr/local
    chdir: "{{ linux_cli_download_dir }}/mosh-{{ mosh_target_version }}"
    creates: "{{ linux_cli_download_dir }}/mosh-{{ mosh_target_version }}/config.status"
  when:
    - ansible_facts.os_family == "Debian"
    - mosh_install_required

- name: Build mosh
  ansible.builtin.command:
    cmd: make -j{{ ansible_facts.processor_vcpus | default(ansible_facts.processor_count | default(1)) }}
    chdir: "{{ linux_cli_download_dir }}/mosh-{{ mosh_target_version }}"
    creates: "{{ linux_cli_download_dir }}/mosh-{{ mosh_target_version }}/src/frontend/mosh"
  when:
    - ansible_facts.os_family == "Debian"
    - mosh_install_required

- name: Install mosh
  ansible.builtin.command:
    cmd: make install
    chdir: "{{ linux_cli_download_dir }}/mosh-{{ mosh_target_version }}"
  changed_when: true
  when:
    - ansible_facts.os_family == "Debian"
    - mosh_install_required

- name: Remove mosh build directory
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/mosh-{{ mosh_target_version }}"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - mosh_install_required

- name: Clean mosh archive
  ansible.builtin.file:
    path: "{{ linux_cli_download_dir }}/mosh.tar.gz"
    state: absent
  when:
    - ansible_facts.os_family == "Debian"
    - mosh_install_required

- name: Capture mosh version after install
  ansible.builtin.command: mosh --version
  register: mosh_version_post
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute installed mosh version string
  ansible.builtin.set_fact:
    mosh_version_post_pretty: >-
      {{ (mosh_version_post.rc == 0) | ternary((mosh_version_post.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report installed mosh version
  ansible.builtin.debug:
    msg: "Mosh version after install: {{ mosh_version_post_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Debug mosh version command result
  ansible.builtin.debug:
    var: mosh_version_post
  when: ansible_facts.os_family == "Debian"

# yt-dlp #######################################################################
- name: Check current yt-dlp version
  ansible.builtin.command: yt-dlp --version
  register: ytdlp_version_check
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute existing yt-dlp version string
  ansible.builtin.set_fact:
    ytdlp_version_pretty: >-
      {{ (ytdlp_version_check.rc == 0) | ternary((ytdlp_version_check.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report existing yt-dlp version
  ansible.builtin.debug:
    msg: "yt-dlp version (pre-install): {{ ytdlp_version_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Fetch latest yt-dlp release metadata
  ansible.builtin.uri:
    url: https://api.github.com/repos/yt-dlp/yt-dlp/releases/latest
    return_content: true
    headers:
      Accept: application/vnd.github+json
      User-Agent: zshell-ansible
  register: ytdlp_release
  retries: 3
  delay: 2
  until: ytdlp_release.status == 200
  when: ansible_facts.os_family == "Debian"

- name: Set yt-dlp release facts
  ansible.builtin.set_fact:
    ytdlp_target_version: "{{ (ytdlp_release.json.tag_name | default('')) | regex_replace('^v', '') }}"
  when: ansible_facts.os_family == "Debian"

- name: Set yt-dlp asset URL
  ansible.builtin.set_fact:
    ytdlp_asset: >-
      {{
        (ytdlp_release.json.assets | default([]))
        | selectattr('name', 'equalto', 'yt-dlp')
        | map(attribute='browser_download_url')
        | list
        | first
        | default('', true)
      }}
  when: ansible_facts.os_family == "Debian"
- name: Debug yt-dlp asset selection
  ansible.builtin.debug:
    msg:
      asset_names: "{{ ytdlp_release.json.assets | default([]) | map(attribute='name') | list }}"
      asset_url: "{{ ytdlp_asset }}"
  when: ansible_facts.os_family == "Debian"

- name: Determine if yt-dlp install is required
  ansible.builtin.set_fact:
    ytdlp_install_required: >-
      {{
        (ytdlp_asset | length > 0) and
        (
          (ytdlp_version_check.rc | default(1)) != 0 or
          (ytdlp_version_check.stdout is defined and ytdlp_target_version not in ytdlp_version_check.stdout)
        )
      }}
  when: ansible_facts.os_family == "Debian"

- name: Download yt-dlp release
  ansible.builtin.get_url:
    url: "{{ ytdlp_asset }}"
    dest: /usr/local/bin/yt-dlp
    mode: "0755"
  when:
    - ansible_facts.os_family == "Debian"
    - ytdlp_install_required

- name: Capture yt-dlp version after install
  ansible.builtin.command: yt-dlp --version
  register: ytdlp_version_post
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Compute installed yt-dlp version string
  ansible.builtin.set_fact:
    ytdlp_version_post_pretty: >-
      {{ (ytdlp_version_post.rc == 0) | ternary((ytdlp_version_post.stdout | default('') | trim), 'not installed') }}
  when: ansible_facts.os_family == "Debian"

- name: Report installed yt-dlp version
  ansible.builtin.debug:
    msg: "yt-dlp version after install: {{ ytdlp_version_post_pretty }}"
  when: ansible_facts.os_family == "Debian"

- name: Debug yt-dlp version command result
  ansible.builtin.debug:
    var: ytdlp_version_post
  when: ansible_facts.os_family == "Debian"
